generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -------------------------------------------------------------
// CORE TENANT AND AUTH (DIY AUTH ARCHITECTURE)
// -------------------------------------------------------------
model Organization {
  id        String   @id @default(uuid())
  name      String
  users     User[]
  projects  Project[]
  
  // Encrypted Integration API Keys
  aiIntegrations UserAiIntegration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  passwordHash   String       // Explicit raw DIY Auth hash
  name           String
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  sessions       Session[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// -------------------------------------------------------------
// AI INTEGRATION AND KMS
// -------------------------------------------------------------
model UserAiIntegration {
  id             String       @id @default(uuid())
  provider       String       // "OPENAI" | "ANTHROPIC" | "GEMINI"
  
  // Enterprise KMS Storage 
  encryptedApiKey String      // AES-256-GCM cipher text
  iv              String      // Initialization vector 
  authTag         String      // GCM auth tag 

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, provider])
}

model AiModelConfig {
  id          String   @id @default(uuid())
  provider    String   // "OPENAI", etc.
  modelId     String   // e.g., "gpt-4o"
  label       String   // e.g., "GPT-4o (Default)"
  isActive    Boolean  @default(true)
}

// -------------------------------------------------------------
// PROJECTS AND THEMES
// -------------------------------------------------------------
model Project {
  id             String       @id @default(uuid())
  name           String
  domainUrl      String
  
  // The API key the Build-Time plugin uses to fetch styles securely
  buildApiKey    String       @unique @default(uuid())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  themes         ToastTheme[]
  webhooks       WebhookEndpoint[]
  
  createdAt      DateTime     @default(now())
}

model ToastTheme {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  variantName String   @default("Default") // For A/B testing
  
  // AI Generated output
  customCss   String
  configJson  String
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WebhookEndpoint {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  url       String
  
  createdAt DateTime @default(now())
}

model TelemetryEvent {
  id        String   @id @default(uuid())
  themeId   String
  eventType String   // "IMPRESSION" | "CLICK" | "DISMISS"
  userAgent String?
  
  createdAt DateTime @default(now())
}
